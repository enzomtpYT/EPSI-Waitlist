{% extends "base.html" %}

{% block title %}Admin - Créer Événement{% endblock %}

{% block content %}
<h1 class="title">Créer un événement</h1>

<div class="admin-section">
    <h2>Informations de l'événement</h2>
    <form action="{{ url_for('create_event.create_event') }}" method="post">
        <label for="name_event">Nom :</label>
        <input type="text" id="name_event" name="name_event">

        <label for="date_event">Date :</label>
        <input type="date" id="date_event" name="date_event">

        <label for="start_time_event">Heure de début :</label>
        <input type="time" id="start_time_event" name="start_time_event">

        <label for="end_time_event">Heure de fin :</label>
        <input type="time" id="end_time_event" name="end_time_event">

        {# <label for="has_timeslots">A crénaux horaires ?</label>
        <input {% if event and event.has_timeslots %}checked{% endif %} onclick="toggleTimeslots()" id="has_timeslots" class="enabletimeslots" type="checkbox" name="has_timeslots">

        <div id="timeslot-section" class="schedules">
            <h3>Créneaux</h3>
            <div id="timeslot-container">
            <!-- Timeslots will be added here dynamically -->
            </div>
            <button type="button" onclick="addTimeslot()">Ajouter un créneau</button>
        </div>

        <input type="hidden" name="timeslots" id="timeslots" value=""> #}

        <label for="event_tags">Tags de l'événement :</label>
        <div id="event_tags" class="taglist">
            <!-- Tags will be dynamically added here -->
        </div>

        <label for="tags">Tags possibles :</label>
        <div id="available_tags" class="taglist">
            {% if tags %}
                {% for tag in tags %}
                <button type="button" class="add-tag" data-tag-id="{{ tag.id_tag }}" data-tag-name="{{ tag.name_tag }}">
                    <svg class="plussvg" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 0 1 1.414 0L10 8.586l4.293-4.293a1 1 0 1 1 1.414 1.414L11.414 10l4.293 4.293a1 1 0 0 1-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 0 1-1.414-1.414L8.586 10 4.293 5.707a1 1 0 0 1 0-1.414" clip-rule="evenodd"></path></svg>
                    {{ tag.name_tag }}
                </button>
                {% endfor %}
            {% else %}
                <p>Aucun tag disponible.</p>
            {% endif %}
        </div>

        <input type="hidden" id="selected_tags" name="selected_tags">

        <div class="mt-5">
            {# <button onclick="addts()" type="submit">Créer</button> #}
            <button type="submit">Créer</button>
        </div>
    </form>
</div>

<script>
let timeslots = {};
let JSid = 0;

function addts(){
    document.querySelectorAll('#timeslot-container > *').forEach((timeslotDiv) => {
        const tempid = timeslotDiv.firstElementChild.id.split('_')[2];
        const tsid = timeslotDiv.querySelector(`#id_timeslot_${tempid}`).value;
        const startInput = timeslotDiv.querySelector(`#start_timeslot_${tempid}`);
        const endInput = timeslotDiv.querySelector(`#end_timeslot_${tempid}`);
        const spotsInput = timeslotDiv.querySelector(`#spots_timeslot_${tempid}`);
        timeslots[tempid] = {start: startInput.value, end: endInput.value, spots: spotsInput.value, id: tsid};
    });
    document.getElementById('timeslots').value = JSON.stringify(timeslots);
}

function addTimeslot(start=null, end=null, spots=null, tsid=null) {
    timeslots[JSid] = {};
    const timeslotContainer = document.getElementById('timeslot-container');
    const timeslotDiv = document.createElement('div');
    timeslotDiv.classList.add('timeslot'+JSid);

    const idInput = document.createElement('input');
    idInput.value = tsid ? tsid : '';
    idInput.type = 'hidden';
    idInput.id = `id_timeslot_${JSid}`;
    timeslotDiv.appendChild(idInput);

    const startLabel = document.createElement('label');
    startLabel.textContent = 'Heure de début :';
    startLabel.htmlFor = `start_timeslot_${JSid}`;

    const startInput = document.createElement('input');
    startInput.value = start;
    startInput.type = 'time';
    startInput.id = `start_timeslot_${JSid}`;
    startInput.placeholder = 'Début';
    startInput.onchange = () => {
        const endInput = timeslotDiv.querySelector('#end_timeslot');
        if (endInput.value === '' || endInput.value < startInput.value) {
            endInput.value = startInput.value;
        }
        timeslots[JSid] = {start: startInput.value, end: endInput.value, spots: spotsInput.value, id: idInput.value};
    };

    const endLabel = document.createElement('label');
    endLabel.textContent = 'Heure de fin :';
    endLabel.htmlFor = `end_timeslot_${JSid}`;

    const endInput = document.createElement('input');
    endInput.value = end;
    endInput.type = 'time';
    endInput.id = `end_timeslot_${JSid}`;
    endInput.placeholder = 'Fin';
    endInput.onchange = () => {
        const startInput = timeslotDiv.querySelector('#start_timeslot');
        if (startInput.value === '' || endInput.value < startInput.value) {
            startInput.value = endInput.value;
        }
        timeslots[JSid] = {start: startInput.value, end: endInput.value, spots: spotsInput.value, id: idInput.value};
    };

    const spotsLabel = document.createElement('label');
    spotsLabel.textContent = 'Nombre de places :';
    spotsLabel.htmlFor = `spots_timeslot_${JSid}`;

    const spotsInput = document.createElement('input');
    spotsInput.value = spots;
    spotsInput.type = 'number';
    spotsInput.id = `spots_timeslot_${JSid}`;
    spotsInput.onchange = () => {
        const spotsInput = timeslotDiv.querySelector('#spots_timeslot');
        timeslots[JSid] = {start: startInput.value, end: endInput.value, spots: spotsInput.value, id: idInput.value};
    };

    const removeButton = document.createElement('button');
    removeButton.type = 'button';
    removeButton.textContent = 'Supprimer';
    removeButton.classList.add('delete');
    removeButton.onclick = () => {
        delete timeslots[JSid];
        timeslotDiv.remove()
    };

    timeslotDiv.appendChild(startLabel);
    timeslotDiv.appendChild(startInput);
    timeslotDiv.appendChild(endLabel);
    timeslotDiv.appendChild(endInput);
    timeslotDiv.appendChild(spotsLabel);
    timeslotDiv.appendChild(spotsInput);
    timeslotDiv.appendChild(removeButton);

    timeslotContainer.appendChild(timeslotDiv);
    JSid++;
}

function toggleTimeslots() {
    const timeslotSection = document.getElementById('timeslot-section');
    timeslotSection.style.display = document.getElementById('has_timeslots').checked ? 'block' : 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    toggleTimeslots();
    addts();
});

{# {% for timeslot in event.timeslots %}
addTimeslot('{{ timeslot.start_timeslot }}', '{{ timeslot.end_timeslot }}', '{{ timeslot.nbr_spots_timeslot }}', '{{ timeslot.id_timeslot }}');
{% endfor %} #}

document.addEventListener('DOMContentLoaded', function() {
    const eventTagsContainer = document.getElementById('event_tags');
    const availableTagsContainer = document.getElementById('available_tags');
    const selectedTagsInput = document.getElementById('selected_tags');

    availableTagsContainer.addEventListener('click', function(event) {
        if (event.target.closest('.add-tag')) {
            const button = event.target.closest('.add-tag');
            const tagId = button.getAttribute('data-tag-id');
            const tagName = button.getAttribute('data-tag-name');

            // Add tag to event tags
            const tagElement = document.createElement('div');
            tagElement.classList.add('tagitem');
            tagElement.style.display = 'inline';
            tagElement.innerHTML = `
                <input type="hidden" name="event_tags[]" value="${tagId}">
                <button class="delete remove-tag" type="button" data-tag-id="${tagId}">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 0 1 1.414 0L10 8.586l4.293-4.293a1 1 0 1 1 1.414 1.414L11.414 10l4.293 4.293a1 1 0 0 1-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 0 1-1.414-1.414L8.586 10 4.293 5.707a1 1 0 0 1 0-1.414" clip-rule="evenodd"></path>
                    </svg>
                    ${tagName}
                </button>
            `;
            eventTagsContainer.appendChild(tagElement);

            // Remove tag from available tags
            button.remove();
        }
    });

    eventTagsContainer.addEventListener('click', function(event) {
        if (event.target.closest('.remove-tag')) {
            const button = event.target.closest('.remove-tag');
            const tagId = button.getAttribute('data-tag-id');
            const tagName = button.textContent.trim();

            // Remove tag from event tags
            button.parentElement.remove();

            // Add tag back to available tags
            const tagButton = document.createElement('button');
            tagButton.type = 'button';
            tagButton.classList.add('add-tag');
            tagButton.setAttribute('data-tag-id', tagId);
            tagButton.setAttribute('data-tag-name', tagName);
            tagButton.innerHTML = `
                <svg class="plussvg" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 0 1 1.414 0L10 8.586l4.293-4.293a1 1 0 1 1 1.414 1.414L11.414 10l4.293 4.293a1 1 0 0 1-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 0 1-1.414-1.414L8.586 10 4.293 5.707a1 1 0 0 1 0-1.414" clip-rule="evenodd"></path>
                </svg>
                ${tagName}
            `;
            availableTagsContainer.appendChild(tagButton);
        }
    });

    // Update hidden input with selected tags before form submission
    document.querySelector('form').addEventListener('submit', function() {
        const selectedTags = Array.from(eventTagsContainer.querySelectorAll('input[name="event_tags[]"]'))
            .map(input => input.value);
        selectedTagsInput.value = selectedTags.join(',');
    });
});

function enableschedules() {
    var enabletimeslots = document.getElementById('has_timeslots');
    var schedules = document.querySelector('.schedules');
    if (enabletimeslots.checked) {
        schedules.style.display = 'flex';
    } else {
        schedules.style.display = 'none';
    }
}
</script>

{% endblock %}