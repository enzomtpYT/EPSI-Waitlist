{% extends "base.html" %}

{% block title %}Admin - Gérer Base de Données{% endblock %}
{% block content %}
<div class="tableContent">
    <div class="dropzone" id="dropzone">
        <div class="importVisual">
            <i class="fa-regular fa-file-arrow-down"></i>
            <p>Glissez et déposez un fichier CSV ici</p>
        </div>
    </div>
    <h1 style="margin-left: 1rem;">Gérer la base de données</h1>
    <div class="tabmanagment">
        <div class="sideItemList">
            <button class="listbtn" onclick="document.querySelector('#fileInput').click()"><i class="fa-regular fa-file-arrow-down"></i> Importer un CSV</button>
            <button class="listbtn" onclick="fetchArchives()"><i class="fa-regular fa-rotate-right"></i> Recharger la liste</button>
        </div>
        <div class="resizer" id="resizer"></div>
        <div class="infoeditor">
            <input type="file" onchange="ImportCSV(event)" hidden id="fileInput" accept=".csv">
            <div class="listsection">
                <h2 style="display: none;">Voir les données</h2>
                <div class="tablewrap" style="flex-grow: 1; display: none;">
                    <table style="height: fit-content;"><thead><tr></tr></thead><tbody></tbody></table>
                </div>
                <button onclick="submit()" style="display: none;"><i class="fa-regular fa-check"></i> Confirmer</button>
                <div onclick="document.querySelector('#fileInput').click()" class="chosedata">
                    <i class="fa-regular fa-file-arrow-down"></i>
                    <h1>Choisir ou importer des données</h1>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let candidates = []

function submit() {
    if (confirm("Êtes-vous sûr de vouloir importer ces données ?")) {
        fetch("{{ url_for('api.import_csv') }}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(candidates)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                popup('success', 'Les données ont été importées avec succès');
            } else {
                popup('danger', 'Une erreur s\'est produite lors de l\'importation des données');
            }
        })
        .catch(error => {
            popup('danger', 'Une erreur s\'est produite lors de l\'importation des données');
            console.error('Error:', error);
        });
    }
}

const dropzone = document.getElementById("dropzone");

document.addEventListener("dragover", (event) => {
    event.preventDefault();
    dropzone.classList.add("visible"); // Show dropzone when dragging over
    setTimeout(() => {
        dropzone.style.opacity = 1;
    }, 1);
});

dropzone.addEventListener("dragleave", (event) => {
    if (!dropzone.contains(event.relatedTarget)) {
        setTimeout(() => {
            dropzone.style.opacity = 0;
        }, 2);
        setTimeout(() => {
            dropzone.classList.remove("visible"); // Hide when dragging leaves window
        }, 251);
    }
});

dropzone.addEventListener("drop", (event) => {
    event.preventDefault();
    setTimeout(() => {
        dropzone.style.opacity = 0;
    }, 2);
    setTimeout(() => {
        dropzone.classList.remove("visible"); // Hide after dropping file
    }, 251);
    const file = event.dataTransfer.files[0];
    const fileInput = document.getElementById("fileInput");
    fileInput.files = event.dataTransfer.files;
    const changeEvent = new Event('change');
    fileInput.dispatchEvent(changeEvent); // Trigger change event
});

function ImportCSV(ev) {
    if (!ev.target.files[0] || !ev.target.files[0].name.endsWith(".csv")) {
        popup('danger', 'Le fichier doit être un fichier CSV');
        return;
    }
    const file = ev.target.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
        const data = e.target.result;
        const lines = data.split("\n");
        const headers = lines[0].split(",");
        const table = document.querySelector(".infoeditor table");
        const thead = table.querySelector("thead");
        const tbody = table.querySelector("tbody");

        // Clear existing table content
        thead.innerHTML = "";
        tbody.innerHTML = "";
        candidates = []

        // Populate headers
        const tr = document.createElement("tr");
        headers.forEach((header) => {
            const th = document.createElement("th");
            th.textContent = header;
            tr.appendChild(th);
        });
        thead.appendChild(tr);

        // Populate rows
        lines.slice(1).forEach((line) => {
            let cand = {};
            const tr = document.createElement("tr");
            const cells = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            if (!cells) return;
            cells.forEach((cell, index) => {
                const td = document.createElement("td");
                td.textContent = cell.replace(/(^"|"$)/g, '');
                tr.appendChild(td);
                switch (index) {
                    case 0:
                        cand.lastname = cell.replace(/(^"|"$)/g, '');
                        break;
                    case 1:
                        cand.name = cell.replace(/(^"|"$)/g, '');
                        break;
                    case 2:
                        cand.email = cell.replace(/(^"|"$)/g, '');
                        break;
                    case 3:
                        cand.username = cell.replace(/(^"|"$)/g, '');
                        break;
                    case 4:
                        tags = cell.replace(/(^"|"$)/g, '');
                        cand.tags = tags.split(",");
                        break;
                    case 5:
                        cand.schoolyear = cell.replace(/(^"|"$)/g, '');
                }
            });
            tbody.appendChild(tr);
            candidates.push(cand);
            // Show table, button and h2 and then hide the h1
            document.querySelector(".listsection .tablewrap").style.display = "flex";
            document.querySelector(".listsection button").style.display = "block";
            document.querySelector(".listsection h2").style.display = "block";
            document.querySelector(".listsection .chosedata").style.display = "none";
        });
    };
    reader.readAsText(file);
}

// Fetch and display the list of archived schemas
function fetchArchives() {
    // Reset the table and sideItemList

    let sideItemList = document.querySelector('.sideItemList');
    const table = document.querySelector(".infoeditor table");
    const thead = table.querySelector("thead");
    const tbody = table.querySelector("tbody");
    sideItemList.innerHTML = `
        <button class="listbtn" onclick="document.querySelector('#fileInput').click()"><i class="fa-regular fa-file-arrow-down"></i> Importer un CSV</button>
        <button class="listbtn" onclick="fetchArchives()"><i class="fa-regular fa-rotate-right"></i> Recharger la liste</button>
    `;

    // Hide table

    document.querySelector(".listsection .tablewrap").style.display = "none";
    document.querySelector(".listsection h2").style.display = "none";
    document.querySelector(".listsection .chosedata").style.display = "flex";

    // Clear existing table content
    thead.innerHTML = "";
    tbody.innerHTML = "";


    fetch("{{ url_for('api.get_archives') }}")
        .then(response => {
            if (!response.ok) {
                popup('danger', 'Une erreur est survenue lors de la récupération des données');
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            buildManagement(data);
        })
        .catch(error => {
            console.error('Error fetching archives:', error);
        });
}

function buildManagement(data) {
    let sideItemList = document.querySelector('.sideItemList');
    data.forEach(schema => {
        let item = document.createElement('div');
        item.classList.add('itemlist');
        item.onclick = function() { viewArchive(schema.candidates); this.classList.add('selected'); document.querySelectorAll('.itemlist').forEach(item => { if (item !== this) item.classList.remove('selected'); }); };
        item.innerHTML = `<i class="fa-regular fa-database"></i><p>${schema.schema_name}</p>`;
        sideItemList.appendChild(item);
    });
}

function viewArchive(archives) {
    const table = document.querySelector(".infoeditor table");
    const thead = table.querySelector("thead");
    const tbody = table.querySelector("tbody");

    // Clear existing table content

    thead.innerHTML = "";
    tbody.innerHTML = "";

    // Populate headers

    const headers = ["Nom", "Prénom", "Email", "Tags", "Actions"];
    const tr = document.createElement("tr");
    headers.forEach((header) => {
        const th = document.createElement("th");
        th.textContent = header;
        tr.appendChild(th);
    });

    thead.appendChild(tr);

    // Populate rows

    archives.forEach((cand) => {
        const tr = document.createElement("tr");

        const lastnameTd = document.createElement("td");
        lastnameTd.textContent = cand.lastname_candidate;
        tr.appendChild(lastnameTd);

        const nameTd = document.createElement("td");
        nameTd.textContent = cand.name_candidate;
        tr.appendChild(nameTd);

        const emailTd = document.createElement("td");
        emailTd.textContent = cand.email_candidate;
        tr.appendChild(emailTd);

        const tagsTd = document.createElement("td");
        cand.tags.forEach(tag => {
            const tagElement = document.createElement("p");
            tagElement.classList.add("display-tag");
            tagElement.textContent = tag.name_tag;
            tagsTd.appendChild(tagElement);
        });
        tr.appendChild(tagsTd);

        const actionTd = document.createElement("td");
        const button = document.createElement("button");
        button.textContent = "Voir Historique";

        button.onclick = () => {
            popup('info', cand.interviews);
        };

        actionTd.appendChild(button);
        tr.appendChild(actionTd);
        tbody.appendChild(tr);

    });

    // Show table

    document.querySelector(".listsection .tablewrap").style.display = "flex";
    document.querySelector(".listsection h2").style.display = "block";
    document.querySelector(".listsection .chosedata").style.display = "none";
}

// Call fetchArchives on page load
document.addEventListener("DOMContentLoaded", function() {
    fetchArchives();
});

</script>
{% endblock %}