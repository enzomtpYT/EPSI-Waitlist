{% extends "base.html" %}

{% block title %}Admin - Gérer Candidats{% endblock %}

{% block content %} 
<div class="tableContent">
    <h1 style="margin-left: 1rem;">Gérer les candidats</h1>
    <h2 style="margin-left: 1rem;" id="loading">Chargement...</h2>
    <div class="tabmanagment" style="display: none;">
        <div class="sideItemList">
            <button class="listbtn" onclick="showNew()"><i class="fa-regular fa-user-plus"></i> Créer un candidat</button>
            <button class="listbtn" onclick="loadData()"><i class="fa-regular fa-rotate-right"></i> Recharger la liste</button>
        </div>
        <div class="resizer" id="resizer"></div>
        <div class="infoeditor">
            <form id="candform" style="display: none;">
                <label for="candidate_lastname">Nom :</label>
                <input type="text" id="candidate_lastname" name="candidate_lastname" value="">
    
                <label for="candidate_name">Prénom :</label>
                <input type="text" id="candidate_name" name="candidate_name" value="">
    
                <label for="candidate_email">E-mail :</label>
                <input type="email" id="candidate_email" name="candidate_email" value="">
    
                <label for="username">Nom d'utilisateur :</label>
                <input type="text" id="username" name="username" value="">
    
                <label for="password">Mot de passe :</label>
                <div class="editpass">
                    <div class="iconified-input">
                        <input type="password" id="password" name="password" value="">
                        <i onclick="showpass()" id="showpass" class="fa-regular fa-eye icon showpass"></i>
                    </div>
                    <button type="button" onclick="generatepass().then(pass => {document.getElementById('password').value = pass})"><i class="fa-regular fa-key"></i> Générer un mot de passe</button>
                </div>
    
                <div>
                    <button id="confirmbtn" disabled></button>
                    <button class="delete" type="submit"><i class="fa-regular fa-trash"></i> Supprimer</button>
                </div>

                <input type="hidden" id="id_candidate" name="id_candidate" value="">
            </form>
            <div class="sectionmanagetag">
                <div class="sectionremovetags">
                    <button class="remove-tag" data-tagid="1"><i class="fa-regular fa-xmark"></i> TagName</button>
                    <button class="remove-tag" data-tagid="2"><i class="fa-regular fa-xmark"></i> TagName</button>
                    <button class="remove-tag" data-tagid="3"><i class="fa-regular fa-xmark"></i> TagName</button>
                    <button class="remove-tag" data-tagid="4"><i class="fa-regular fa-xmark"></i> TagName</button>
                    <button class="remove-tag" data-tagid="5"><i class="fa-regular fa-xmark"></i> VerySuperDuperMassiveLongTagName</button>
                    <button class="remove-tag" data-tagid="6"><i class="fa-regular fa-xmark"></i> TagName</button>
                    <button class="remove-tag" data-tagid="7"><i class="fa-regular fa-xmark"></i> TagName</button>
                    <button class="remove-tag" data-tagid="8"><i class="fa-regular fa-xmark"></i> TagName</button>
                    <button class="remove-tag" data-tagid="9"><i class="fa-regular fa-xmark"></i> TagName</button>
                    <button class="remove-tag" data-tagid="10"><i class="fa-regular fa-xmark"></i> TagName</button>
                </div>
                <div class="sectionaddtags">
                    <button class="add-tag" data-tagid="1"><i class="fa-regular fa-plus"></i> TagName</button>
                    <button class="add-tag" data-tagid="2"><i class="fa-regular fa-plus"></i> TagName</button>
                    <button class="add-tag" data-tagid="3"><i class="fa-regular fa-plus"></i> TagName</button>
                    <button class="add-tag" data-tagid="4"><i class="fa-regular fa-plus"></i> TagName</button>
                    <button class="add-tag" data-tagid="5"><i class="fa-regular fa-plus"></i> VerySuperDuperMassiveLongTagName</button>
                    <button class="add-tag" data-tagid="6"><i class="fa-regular fa-plus"></i> TagName</button>
                    <button class="add-tag" data-tagid="7"><i class="fa-regular fa-plus"></i> TagName</button>
                    <button class="add-tag" data-tagid="8"><i class="fa-regular fa-plus"></i> TagName</button>
                    <button class="add-tag" data-tagid="9"><i class="fa-regular fa-plus"></i> TagName</button>
                    <button class="add-tag" data-tagid="10"><i class="fa-regular fa-plus"></i> TagName</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let AllTags = null;

function loadData() {
    document.querySelectorAll('.itemlist').forEach(item => item.remove());
    document.querySelectorAll('.sectionaddtags button').forEach(tag => tag.remove());
    document.querySelectorAll('.sectionremovetags button').forEach(tag => tag.remove());
    fetch('{{ url_for('api.get_tags') }}')
        .then(response => {
            if (!response.ok) {
                popup('danger', 'Une erreur est survenue lors de la récupération des données');
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(datas => {
            AllTags = datas;
        })
        .catch(error => {
            popup('danger', 'Une erreur est survenue lors de la récupération des données');
            console.error('Error:', error);
        });
    fetch('{{ url_for('api.get_candidates') }}')
        .then(response => {
            if (!response.ok) {
                popup('danger', 'Une erreur est survenue lors de la récupération des données');
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(datas => {
            buildManagement(datas, AllTags);
        })
        .catch(error => {
            popup('danger', 'Une erreur est survenue lors de la récupération des données');
            console.error('Error:', error);
        });
}

function showInfos(infos) {
    document.querySelector('#candidate_lastname').value = infos.lastname_candidate;
    document.querySelector('#candidate_name').value = infos.name_candidate;
    document.querySelector('#candidate_email').value = infos.email_candidate;
    document.querySelector('#username').value = infos.username;
    document.querySelector('#id_candidate').value = infos.id_candidate;
    document.querySelector('#password').value = '';
    document.querySelector('#confirmbtn').innerHTML = '<i class="fa-regular fa-save"></i> Enregistrer';
    document.querySelector('#candform').style.display = 'flex';
    document.querySelector('.sectionmanagetag').style.display = 'flex';
    document.querySelector('.delete').onclick = function() {
        deleteType('candidate', infos.id_candidate);
    };
    document.querySelector('.delete').style.display = 'inline';
    document.querySelector('.sectionremovetags').innerHTML = '';
    document.querySelector('.sectionaddtags').innerHTML = '';
    infos.tags.forEach(tag => {
        let tagButton = document.createElement('button');
        tagButton.classList.add('remove-tag');
        tagButton.dataset.tagid = tag.id_tag;
        tagButton.innerHTML = `<i class="fa-regular fa-xmark"></i> ${tag.name_tag}`;
        tagButton.onclick = function() {
            removeTag(infos.id_candidate, tag.id_tag);
        };
        document.querySelector('.sectionremovetags').appendChild(tagButton);
    });
    AllTags.forEach(tag => {
        if (!infos.tags.some(userTag => userTag.id_tag === tag.id_tag)) {
            let tagButton = document.createElement('button');
            tagButton.classList.add('add-tag');
            tagButton.dataset.tagid = tag.id_tag;
            tagButton.innerHTML = `<i class="fa-regular fa-plus"></i> ${tag.name_tag}`;
            tagButton.onclick = function() {
                addTag(infos.id_candidate, tag.id_tag);
            };
            document.querySelector('.sectionaddtags').appendChild(tagButton);
        }
    });
}

function showNew() {
    document.querySelectorAll('.itemlist').forEach(item => { item.classList.remove('selected'); });
    document.querySelector('#candidate_lastname').value = '';
    document.querySelector('#candidate_name').value = '';
    document.querySelector('#candidate_email').value = '';
    document.querySelector('#username').value = '';
    document.querySelector('#id_candidate').value = '';
    document.querySelector('#password').value = '';
    document.querySelector('#confirmbtn').innerHTML = '<i class="fa-regular fa-save"></i> Enregistrer';
    document.querySelector('#candform').style.display = 'flex';
    document.querySelector('.delete').style.display = 'none';
    document.querySelector('.sectionremovetags').innerHTML = '';
    document.querySelector('.sectionaddtags').innerHTML = '';
    AllTags.forEach(tag => {
        let tagButton = document.createElement('button');
        tagButton.classList.add('add-tag');
        tagButton.dataset.tagid = tag.id_tag;
        tagButton.innerHTML = `<i class="fa-regular fa-plus"></i> ${tag.name_tag}`;
        tagButton.onclick = function() {
            addTag(null, tag.id_tag);
        };
        document.querySelector('.sectionaddtags').appendChild(tagButton);
    });
}

function buildManagement(datas, tags) {
    let sideItemList = document.querySelector('.sideItemList');
    datas.forEach(candidate => {
        let item = document.createElement('div');
        item.classList.add('itemlist');
        item.onclick = function() { showInfos(candidate); this.classList.add('selected'); document.querySelectorAll('.itemlist').forEach(item => { if (item !== this) item.classList.remove('selected'); }); };
        item.id = `deleteElement-${candidate.id_candidate}-candidate`;
        item.innerHTML = `<i class="fa-regular fa-user"></i><p>${candidate.name_candidate} ${candidate.lastname_candidate}</p>`;
        sideItemList.appendChild(item);
    });
    document.querySelector('#loading').style.display = 'none';
    document.querySelector('.tabmanagment').style.display = 'flex';
    {# let pre = document.createElement('pre');
    let code = document.createElement('code');
    mark(code, JSON.stringify({tags: tags, datas: datas}, null, 2));
    pre.appendChild(code);
    document.querySelector('.infoeditor').appendChild(pre); #}
}
loadData();


/* Resizer */

var resize = document.querySelector("#resizer");
var left = document.querySelector(".sideItemList");
var container = document.querySelector(".tabmanagment");
var moveX = left.getBoundingClientRect().width + resize.getBoundingClientRect().width / 2;
var drag = false;

resize.addEventListener("mousedown", function (e) {
   drag = true;
   moveX = e.x;
});

container.addEventListener("mousemove", function (e) {
   moveX = e.x;
   if (drag) {
      left.style.width =
         moveX - resize.getBoundingClientRect().width / 2 + "px";
      e.preventDefault();
   }
});

container.addEventListener("mouseup", function (e) {
   drag = false;
});

/* End Resizer */

</script>
{% endblock %}