{% extends "base.html" %}

{% block title %}Admin - Gérer Base de Données{% endblock %}
{% block content %}
<div class="tableContent">
    <div class="dropzone" id="dropzone">
        <div class="importVisual">
            <i class="fa-regular fa-file-arrow-down"></i>
            <p>Glissez et déposez un fichier CSV ici</p>
        </div>
    </div>
    <h1 style="margin-left: 1rem;">Gérer la base de données</h1>
    <div class="tabmanagment">
        <div class="sideItemList">
            <button class="listbtn" onclick="document.querySelector('#fileInput').click()"><i class="fa-regular fa-file-arrow-down"></i> Importer un CSV</button>
            <button class="listbtn" onclick="exportCSV()"><i class="fa-regular fa-file-arrow-up"></i> Exporter un CSV</button>
            <button class="listbtn" onclick="reload()"><i class="fa-regular fa-rotate-right"></i> Recharger la liste</button>
        </div>
        <div class="resizer" id="resizer"></div>
        <div class="infoeditor">
            <input type="file" onchange="ImportCSV(event)" hidden id="fileInput" accept=".csv">
            <div class="listsection" display="none">
                <h2>Voir</h2>
                <div class="tablewrap" style="flex-grow: 1;">
                    <table><thead><tr></tr></thead><tbody></tbody></table>
                </div>
                <button><i class="fa-regular fa-check"></i> Confirmer</button>
            </div>
        </div>
    </div>
</div>

<script>
function importCSV() {
    
}

const dropzone = document.getElementById("dropzone");

document.addEventListener("dragover", (event) => {
    event.preventDefault();
    dropzone.classList.add("visible"); // Show dropzone when dragging over
    setTimeout(() => {
        dropzone.style.opacity = 1;
    }, 1);
});

dropzone.addEventListener("dragleave", (event) => {
    if (!dropzone.contains(event.relatedTarget)) {
        setTimeout(() => {
            dropzone.style.opacity = 0;
        }, 2);
        setTimeout(() => {
            dropzone.classList.remove("visible"); // Hide when dragging leaves window
        }, 251);
    }
});

dropzone.addEventListener("drop", (event) => {
    event.preventDefault();
    setTimeout(() => {
        dropzone.style.opacity = 0;
    }, 2);
    setTimeout(() => {
        dropzone.classList.remove("visible"); // Hide after dropping file
    }, 251);
    const file = event.dataTransfer.files[0];
    const fileInput = document.getElementById("fileInput");
    fileInput.files = event.dataTransfer.files;
    const changeEvent = new Event('change');
    fileInput.dispatchEvent(changeEvent); // Trigger change event
});

function ImportCSV(ev) {
    if (!ev.target.files[0] || !ev.target.files[0].name.endsWith(".csv")) {
        popup('danger', 'Le fichier doit être un fichier CSV');
        return;
    }
    const file = ev.target.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
        const data = e.target.result;
        const lines = data.split("\n");
        const headers = lines[0].split(",");
        const table = document.querySelector(".infoeditor table");
        const thead = table.querySelector("thead");
        const tbody = table.querySelector("tbody");

        // Clear existing table content
        thead.innerHTML = "";
        tbody.innerHTML = "";

        // Populate headers
        const tr = document.createElement("tr");
        headers.forEach((header) => {
            const th = document.createElement("th");
            th.textContent = header;
            tr.appendChild(th);
        });
        thead.appendChild(tr);

        // Populate rows
        lines.slice(1).forEach((line) => {
            const tr = document.createElement("tr");
            const cells = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            cells.forEach((cell) => {
            const td = document.createElement("td");
            td.textContent = cell.replace(/(^"|"$)/g, ''); // Remove surrounding quotes if any
            tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
    };
    reader.readAsText(file);
}

</script>
{% endblock %}