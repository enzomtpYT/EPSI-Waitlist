{% extends "base.html" %}

{% block title %}Liste{% endblock %}

{% block content %}
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/list.css') }}">
  {% if datas.message %}
    <h1 class="title">{{ datas.message }}</h1>
  {% else %}
    <h1 class="title">{{ datas.title }}</h1>
    <div class="listcontainer">
      {% for dict_item in datas.list %}
        {% for key, value in dict_item.items() %}
          <div class="column">
            <h2 class="interv">{{ key }}</h2>
            <div class="candidates">
              {% for item in value %}
                {% if loop.index <= 5 %}
                  {% if loop.index == 1 %}
                    <div class="managecandidate current" id="interview-{{ item.id_interview }}">
                  {% else %}
                    <div class="managecandidate" id="interview-{{ item.id_interview }}">
                  {% endif %}
                  <div class="dropdown">
                    <button>{{ item.name_candidate }} {{ item.lastname_candidate }}</button>
                    <div class="dropdown-content">
                      <form action="{{ url_for('list.remove_candidate_from_list', id_interview=item.id_interview) }}" method="post" style="display:inline;">
                        <button type="submit" class="dropdown-item">Supprimer cet entretien</button>
                      </form>
                      <form action="{{ url_for('list.remove_candidate_from_all_interviews_for_event', id_event=datas.event_id, id_candidate=item.id_candidate) }}" method="post" style="display:inline;">
                        <button type="submit" class="dropdown-item">Supprimer tous les entretiens de ce candidat</button>
                      </form>
                    </div></div>

                    <div>
                      <button class="shy" onclick="startInterview({{ item.id_interview }})">Commencer</button>
                    </div>
                    <div id="duration-{{ item.id_interview }}" class="duration">00:00</div>

                    <div class="stacked-button">
                      <button onclick="handleEndInterview(event, {{ item.id_interview }})" class="shy" type="submit">Entretien termin√©</button>
                      <button class="shy">Suivant</button>
                    </div>
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      {% endfor %}
    </div>

<script>
let timers = {};
function startInterview(id_interview) {
    fetch('/api/start_interview', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ id_interview: id_interview })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            startCountdown(id_interview);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while starting the interview.');
    });
}
function startCountdown(id_interview) {
    const display = document.getElementById(`duration-${id_interview}`);
    let startTime = new Date();
    timers[id_interview] = setInterval(() => {
        let now = new Date();
        let elapsed = new Date(now - startTime);
        let minutes = elapsed.getUTCMinutes();
        let seconds = elapsed.getUTCSeconds();
        display.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    }, 1000);
}
function endInterview(id_interview) {
    clearInterval(timers[id_interview]);
    fetch('/api/end_interview', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ id_interview: id_interview })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            alert('Interview ended successfully');
            // Remove the interview element from the DOM
            const interviewElement = document.getElementById(`interview-${id_interview}`);
            if (interviewElement) {
                interviewElement.remove();
            }
            // Update the remaining interviews
            updateInterviews();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while ending the interview.');
    });
}
function handleEndInterview(event, id_interview) {
    event.preventDefault();
    endInterview(id_interview);
}
function updateInterviews() {
    document.querySelectorAll('.candidates').forEach(item => {
        if (item.firstElementChild) {
            item.firstElementChild.classList.add('current');
        }
    });
}
</script>

  {% endif %}
{% endblock %}